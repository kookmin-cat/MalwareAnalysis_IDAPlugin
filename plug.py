# -*- coding: utf-8 -*-
from __future__ import unicode_literals
import idaapi
import floss.main
import floss.identification_manager as floss_im
import floss.string_decoder
import floss.function_argument_getter
import viv_utils
import time

#---------------------------------------------------------------------
class TraceFunctionHook(idaapi.UI_Hooks):
    def __init__(self):
        idaapi.UI_Hooks.__init__(self)
        self.cmdname = "<no command>"
        self.funclistque = []

    def saving(self):
        if PluginActiveFlag == True:
            backtracef_hook.unhook()
            backtraceV.close()
    def get_ea_hint(self, ea):
        print "get_ea_hint(%x)" % ea

    def get_item_hint(self, ea, max_lines):
        print "get_item_hint(%x)" % ea

    def get_custom_viewer_hint(self, viewer, place):
        global backtraceV
        if place != None:
            ea = place.toea()
            prevFunc = idaapi.get_func(ea)
            try:
                prevFuncEA = prevFunc.start_ea
                try:
                    index = self.funclistque.index(prevFuncEA)
                    self.funclistque = self.funclistque[0:index+1]
                except ValueError:
                    self.funclistque.append(prevFuncEA)
            except:
                pass
        backtraceV.ClearLines()
        for fea in self.funclistque:
            backtraceV.AddLine(get_name(fea))
        backtraceV.Refresh()

class FlossLib:
    def do_floss(self):
        result = self.floss_analyze()
        self.floss_make_comments(result)
        return result

    def floss_load_workspace(self):
        return viv_utils.loadWorkspaceFromIdb()

    def floss_analyze(self, decoders=None, vw=None):
        if vw is None:
            print('floss_analyze: loading workspace...')
            vw = self.floss_load_workspace()
        if decoders is None or len(decoders) == 0:
            print('floss_analyze: identifying decoding functions...')
            functions = floss.main.select_functions(vw, '')
            plugins = floss.main.get_all_plugins()
            candidates = floss_im.identify_decoding_functions(vw, plugins, functions)
            decoders = []
            for fva, _ in candidates.get_top_candidate_functions(10):
                decoders.append(fva)
        print('floss_analyze: decoding strings...')
        result = self.floss_decode_strings(vw, decoders)
        print('floss_analyze: done')
        return result

    def floss_decode_strings(self, vw, decoders, min_length=4, no_filter=False, max_insn=2000, max_hits=1):
        decoded_strings = []
        function_index = viv_utils.InstructionFunctionIndex(vw)

        for fva in decoders:
            for ctx in floss.string_decoder.extract_decoding_contexts(vw, fva, max_hits):
                for delta in floss.string_decoder.emulate_decoding_routine(vw, function_index, fva, ctx, max_insn):
                    for delta_bytes in floss.string_decoder.extract_delta_bytes(delta, ctx.decoded_at_va, fva):
                        for decoded_string in floss.string_decoder.extract_strings(delta_bytes, min_length, no_filter):
                            decoded_strings.append(decoded_string)

        return decoded_strings

    def floss_make_comments(self, decoded_strings):
        for s in decoded_strings:
            MakeComm(s.va, s.s.encode('utf8'))
            MakeComm(s.decoded_at_va, s.s.encode('utf8'))
            self.floss_make_decompiler_comment(s.decoded_at_va, s.s.encode('utf8'))

    def floss_make_decompiler_comment(self, ea, str):
        cfunc = idaapi.decompile(ea)
        tl = idaapi.treeloc_t()
        tl.ea = ea
        tl.itp = idaapi.ITP_SEMI
        cfunc.set_user_cmt(tl, str)
        cfunc.save_user_cmts()

#---------------------------------------------------------------------
def show(popup):
    popup.Show()

def refresh(popup):
    popup.ClearLines()
    popup.Refresh()

def ChangePluginStatus():
    global PluginActiveFlag
    global backtracef_hook
    if PluginActiveFlag == False:
        PluginActiveFlag = True
        print "[+] BackTrace Run!!!"
        show(backtraceV)
        backtracef_hook.hook()

    else:
        PluginActiveFlag = False
        print "[-] BackTrace Stop!!!"
        backtracef_hook.unhook()
        refresh(backtraceV)
        backtracef_hook.funclistque=[]

def Floss():
    fl = FlossLib()
    decryptV.Show()
    time.sleep(1)
    print "[+] Load Floss Module"
    decryptlist = fl.do_floss()
    for de in decryptlist:
        try:
            addr = de.decoded_at_va
        except:
            continue
        tmp = "DecryptEA: 0x%x | DecryptString: %s"%(de.decoded_at_va, de.s.encode())
        decryptV.AddLine(tmp)
    decryptV.Refresh()

#---------------------------------------------------------------------    
if __name__ == "__main__":
    # Global Variable - BackTrace
    PluginActiveFlag = False
    backtraceV = idaapi.simplecustviewer_t()
    backtraceV.Create("BackTrace")
    backtracef_hook = None
    backtracef_hook = TraceFunctionHook()

    decryptV = idaapi.simplecustviewer_t()
    decryptV.Create("DecryptList")
    # Create HotKey
    idaapi.add_hotkey("F3", ChangePluginStatus)
    idaapi.add_hotkey("F4", Floss)
